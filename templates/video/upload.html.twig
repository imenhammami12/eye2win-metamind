{% extends 'base.html.twig' %}

{% block title %}Uploader une vidéo{% endblock %}

{% block body %}
<section class="upload-hero">
    <div class="container">
        <div class="upload-hero__content">
            <div>
                <p class="upload-hero__eyebrow">Espace joueur</p>
                <h1 class="upload-hero__title">Uploader une vidéo</h1>
                <p class="upload-hero__subtitle">Partagez vos matchs en privé ou en public, avec un upload sécurisé et rapide.</p>
            </div>
            <div class="upload-hero__badge">
                <i class="bi bi-cloud-check"></i>
                Stockage Cloudinary
            </div>
        </div>
    </div>
</section>

<section class="upload-section">
    <div class="container">
        <div class="upload-grid">
            <div class="upload-panel">
                <div class="upload-panel__header">
                    <div>
                        <p class="upload-panel__eyebrow">Étape 1</p>
                        <h5 class="upload-panel__title">Détails de la vidéo</h5>
                    </div>
                    <span class="upload-status"><i class="bi bi-shield-lock"></i> Sécurisé</span>
                </div>
                <div class="upload-panel__body">
                    {{ form_start(form, { attr: { id: 'userVideoUploadForm' } }) }}
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label">Titre <span class="text-danger">*</span></label>
                                {{ form_widget(form.title, { attr: { class: 'form-control' } }) }}
                                <small class="form-text">Un titre court et descriptif</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Type de jeu <span class="text-danger">*</span></label>
                                {{ form_widget(form.gameType, { attr: { class: 'form-control' } }) }}
                                <small class="form-text">Exemple : Valorant, CS2, FIFA</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Visibilité <span class="text-danger">*</span></label>
                                {{ form_widget(form.visibility, { attr: { class: 'form-select visibility-select' } }) }}
                                <small class="form-text">Privé par défaut</small>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Fichier vidéo (MP4) <span class="text-danger">*</span></label>
                                {{ form_widget(form.videoFile, { attr: { class: 'form-control' } }) }}
                                <small class="form-text">MP4 uniquement, max 200MB</small>
                            </div>
                        </div>

                        <div class="upload-info">
                            <i class="bi bi-info-circle"></i>
                            <div>
                                <strong>Bon à savoir</strong>
                                <p class="mb-0">Les vidéos privées ne sont visibles que par vous. Vous pouvez changer la visibilité plus tard.</p>
                            </div>
                        </div>

                        <div id="userUploadProgress" class="mt-4 d-none">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>Progression</strong>
                                <span id="userUploadProgressText" class="text-muted">Upload en cours... 0%</span>
                            </div>
                            <div class="progress" style="height: 10px;">
                                <div id="userUploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>

                        <div class="upload-actions">
                            <button class="btn btn-primary" type="submit">
                                <i class="bi bi-upload me-2"></i>Uploader
                            </button>
                            <span class="upload-note">Stockage sécurisé et traitement automatique.</span>
                        </div>
                    {{ form_end(form) }}
                </div>
            </div>

            <aside class="upload-sidebar">
                <div class="upload-card">
                    <h6><i class="bi bi-lightning-charge"></i> Conseils rapides</h6>
                    <ul>
                        <li>MP4 recommandé pour de meilleures performances.</li>
                        <li>Gardez la durée raisonnable pour un upload rapide.</li>
                        <li>Ajoutez un titre clair pour faciliter la recherche.</li>
                    </ul>
                </div>
                <div class="upload-card">
                    <h6><i class="bi bi-eye"></i> Visibilité</h6>
                    <p>Public : visible par les autres joueurs. Privé : visible uniquement par vous.</p>
                </div>
            </aside>
        </div>
    </div>
</section>

<style>
    .upload-hero {
        padding: 3rem 0 2rem;
        background: radial-gradient(circle at top left, rgba(79, 70, 229, 0.25), transparent 55%),
            radial-gradient(circle at top right, rgba(168, 85, 247, 0.2), transparent 60%);
    }

    .upload-hero__content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 2rem;
        color: #f8fafc;
        flex-wrap: wrap;
    }

    .upload-hero__eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.2rem;
        font-size: 0.75rem;
        color: #c7d2fe;
        margin-bottom: 0.5rem;
    }

    .upload-hero__title {
        font-size: 2.3rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
    }

    .upload-hero__subtitle {
        color: #e2e8f0;
        max-width: 520px;
    }

    .upload-hero__badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.12);
        color: #e2e8f0;
        font-weight: 600;
    }

    .upload-section {
        padding: 2rem 0 4rem;
    }

    .upload-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 320px;
        gap: 2rem;
    }

    .upload-panel {
        background: rgba(15, 18, 30, 0.94);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 24px;
        overflow: hidden;
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.35);
    }

    .upload-panel__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.5rem 2rem;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.9), rgba(139, 92, 246, 0.9));
        color: #fff;
    }

    .upload-panel__eyebrow {
        margin: 0;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.15rem;
        opacity: 0.8;
    }

    .upload-panel__title {
        margin: 0.25rem 0 0;
        font-size: 1.15rem;
        font-weight: 700;
    }

    .upload-status {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        background: rgba(255, 255, 255, 0.2);
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .upload-panel__body {
        padding: 2rem;
    }

    .upload-sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .upload-card {
        background: rgba(15, 18, 30, 0.88);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 18px;
        padding: 1.5rem;
        color: #e2e8f0;
    }

    .upload-card h6 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        font-weight: 700;
        color: #fff;
    }

    .upload-card ul {
        padding-left: 1.2rem;
        margin-bottom: 0;
    }

    .upload-card li {
        margin-bottom: 0.5rem;
    }

    .form-label {
        color: #e5e7eb;
        font-weight: 600;
        margin-bottom: 0.35rem;
        display: block;
    }

    .form-text {
        color: #9ca3af;
        font-size: 0.85rem;
        display: block;
        margin-top: 0.45rem;
        line-height: 1.4;
    }

    .form-control,
    .form-select {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 14px;
        color: #f3f4f6;
        padding: 0.75rem 1rem;
        min-height: 48px;
        line-height: 1.3;
        font-size: 0.95rem;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: rgba(99, 102, 241, 0.85);
        box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.2);
        background: rgba(255, 255, 255, 0.08);
    }

    .visibility-select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        height: 48px;
        padding: 0 2.5rem 0 1rem;
        line-height: 48px;
        background-color: #111827;
        background-image: linear-gradient(45deg, transparent 50%, #94a3b8 50%),
            linear-gradient(135deg, #94a3b8 50%, transparent 50%),
            linear-gradient(to right, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.12));
        background-position: calc(100% - 18px) 50%, calc(100% - 12px) 50%, calc(100% - 2.5rem) 0.6rem;
        background-size: 6px 6px, 6px 6px, 1px 1.8rem;
        background-repeat: no-repeat;
    }

    .visibility-select:focus {
        border-color: rgba(99, 102, 241, 0.9);
        box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.2);
    }

    .form-select option {
        color: #111827;
        background: #ffffff;
        line-height: 1.4;
    }

    .form-control[type="file"] {
        padding: 0.55rem 0.9rem;
    }

    .upload-info {
        margin-top: 1.75rem;
        display: flex;
        gap: 0.75rem;
        background: rgba(99, 102, 241, 0.12);
        border: 1px solid rgba(99, 102, 241, 0.25);
        border-radius: 14px;
        padding: 1rem 1.25rem;
        color: #cbd5f5;
    }

    .upload-info i {
        font-size: 1.4rem;
        color: #a5b4fc;
        margin-top: 0.15rem;
    }

    .upload-actions {
        margin-top: 1.75rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
    }

    .upload-actions .btn-primary {
        padding: 0.75rem 2.5rem;
        border-radius: 999px;
        font-weight: 600;
        box-shadow: 0 12px 28px rgba(99, 102, 241, 0.35);
    }

    .upload-note {
        color: #9ca3af;
        font-size: 0.9rem;
    }

    .progress {
        border-radius: 999px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.08);
    }

    .progress-bar {
        background: linear-gradient(90deg, #6366f1, #a855f7);
    }

    @media (max-width: 992px) {
        .upload-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .upload-panel__body {
            padding: 1.5rem;
        }

        .upload-actions {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('userVideoUploadForm');
    const progressWrap = document.getElementById('userUploadProgress');
    const progressBar = document.getElementById('userUploadProgressBar');
    const progressText = document.getElementById('userUploadProgressText');

    if (!form) {
        return;
    }

    form.addEventListener('submit', function (event) {
        event.preventDefault();

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const actionUrl = form.getAttribute('action') || window.location.href;
        const xhr = new XMLHttpRequest();
        xhr.open(form.method.toUpperCase(), actionUrl);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        progressWrap.classList.remove('d-none');
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', '0');
        progressText.textContent = 'Upload en cours... 0%';

        xhr.upload.addEventListener('progress', function (e) {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percent + '%';
                progressBar.setAttribute('aria-valuenow', String(percent));
                progressText.textContent = 'Upload en cours... ' + percent + '%';
            }
        });

        xhr.onload = function () {
            if (xhr.status >= 200 && xhr.status < 300) {
                const contentType = xhr.getResponseHeader('Content-Type') || '';
                if (contentType.includes('application/json')) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data.redirect) {
                            window.location = data.redirect;
                            return;
                        }
                    } catch (e) {
                        // ignore JSON parse errors
                    }
                } else {
                    document.open();
                    document.write(xhr.responseText);
                    document.close();
                    return;
                }
                window.location = xhr.responseURL || form.action;
            } else {
                try {
                    const data = JSON.parse(xhr.responseText);
                    if (data.error) {
                        if (Array.isArray(data.details) && data.details.length) {
                            progressText.textContent = data.error + ' ' + data.details.join(' | ');
                        } else {
                            progressText.textContent = data.error;
                        }
                        return;
                    }
                } catch (e) {
                    // ignore JSON parse errors
                }
                progressText.textContent = 'Échec de l\'upload. Veuillez réessayer.';
            }
        };

        xhr.onerror = function () {
            progressText.textContent = 'Erreur réseau. Veuillez réessayer.';
        };

        xhr.send(new FormData(form));
    });
});
</script>
{% endblock %}
