{% extends 'base.html.twig' %}

{% block title %}Upload a video{% endblock %}

{% block body %}
<section class="upload-shell">
    <div class="container">
        <div class="upload-header">
            <div>
                <p class="upload-kicker">Player space</p>
                <h1>Upload a video</h1>
                <p class="upload-subtitle">Choose visibility and upload your match securely.</p>
            </div>
            <div class="upload-badge"><i class="bi bi-cloud-check" aria-hidden="true"></i> Cloudinary</div>
        </div>

        <div class="upload-layout">
            <div class="upload-card">
                <div class="upload-card__header">
                    <div>
                        <span class="upload-step">Step 1</span>
                        <h3>Video details</h3>
                    </div>
                    <span class="upload-secure"><i class="bi bi-shield-lock" aria-hidden="true"></i> Secure</span>
                </div>

                <div class="upload-card__body">
                    {{ form_start(form, { attr: { id: 'userVideoUploadForm' } }) }}
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label">Title <span class="text-danger">*</span></label>
                                {{ form_widget(form.title, { attr: { class: 'form-control' } }) }}
                                <small class="form-text">Short and descriptive title</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Game type <span class="text-danger">*</span></label>
                                {{ form_widget(form.gameType, { attr: { class: 'form-control' } }) }}
                                <small class="form-text">Example: Valorant, CS2, FIFA</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Visibility <span class="text-danger">*</span></label>
                                <div class="visibility-options">
                                    {{ form_widget(form.visibility) }}
                                </div>
                                <small class="form-text">Private by default</small>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Video file (MP4) <span class="text-danger">*</span></label>
                                {{ form_widget(form.videoFile, { attr: { class: 'form-control', 'accept': '.mp4,.MP4' } }) }}
                                <small class="form-text">MP4 only, max 200MB</small>
                            </div>
                        </div>

                        <div class="upload-info">
                            <i class="bi bi-info-circle" aria-hidden="true"></i>
                            <div>
                                <strong>Good to know</strong>
                                <p class="mb-0">Private videos are only visible to you. You can change visibility later.</p>
                            </div>
                        </div>

                        <div id="userUploadProgress" class="mt-4 d-none">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>Progress</strong>
                                <span id="userUploadProgressText" class="text-muted">Uploading... 0%</span>
                            </div>
                            <div class="progress" style="height: 10px;">
                                <div id="userUploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>

                        <div class="upload-actions">
                            <button class="btn btn-primary" type="submit">
                                <i class="bi bi-upload me-2" aria-hidden="true"></i>Upload
                            </button>
                            <span class="upload-note">Secure storage and automatic processing.</span>
                        </div>
                    {{ form_end(form) }}
                </div>
            </div>

            <aside class="upload-side">
                <div class="upload-side__card">
                    <h4><i class="bi bi-lightning-charge" aria-hidden="true"></i> Quick tips</h4>
                    <ul>
                        <li>MP4 recommended for best performance</li>
                        <li>Reduce file size for faster upload</li>
                        <li>Choose a clear, precise title</li>
                    </ul>
                </div>
                <div class="upload-side__card">
                    <h4><i class="bi bi-eye" aria-hidden="true"></i> Visibility</h4>
                    <p>Public: visible to other players. Private: visible only to you.</p>
                </div>
            </aside>
        </div>
    </div>
</section>

<style>
    .upload-shell {
        padding: 2.5rem 0 4rem;
        background: #0b0d18;
        color: #f8fafc;
    }

    .upload-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 2rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .upload-kicker {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.2rem;
        color: #a5b4fc;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .upload-subtitle {
        color: #cbd5f5;
        max-width: 520px;
    }

    .upload-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 1.2rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(15, 23, 42, 0.8);
        color: #e2e8f0;
        font-weight: 600;
    }

    .upload-layout {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 320px;
        gap: 2rem;
        align-items: start;
    }

    .upload-card {
        background: rgba(17, 24, 39, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 22px;
        overflow: hidden;
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.35);
    }

    .upload-card__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.95), rgba(139, 92, 246, 0.95));
        color: #fff;
    }

    .upload-step {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.15rem;
        color: rgba(255, 255, 255, 0.85);
        font-weight: 600;
    }

    .upload-secure {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.8rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.18);
        font-size: 0.8rem;
        font-weight: 600;
    }

    .upload-card__body {
        padding: 2rem;
    }

    .upload-side {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .upload-side__card {
        background: rgba(17, 24, 39, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 1.5rem;
        color: #e2e8f0;
    }

    .upload-side__card h4 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        font-weight: 700;
        color: #fff;
        font-size: 1.05rem;
    }

    .form-label {
        display: block;
        color: #e5e7eb;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .form-text {
        color: #94a3b8;
        font-size: 0.85rem;
        display: block;
        margin-top: 0.4rem;
        line-height: 1.4;
    }

    .form-control,
    .form-select {
        width: 100%;
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        color: #f8fafc;
        padding: 0.75rem 1rem;
        min-height: 48px;
        line-height: 1.4;
        font-size: 0.95rem;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: rgba(99, 102, 241, 0.9);
        box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.2);
        outline: none;
    }

    .visibility-options {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 0.25rem;
    }

    .visibility-options .form-check {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(15, 23, 42, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 999px;
        padding: 0.45rem 0.9rem;
    }

    .visibility-options .form-check-input {
        margin: 0;
        width: 1rem;
        height: 1rem;
        accent-color: #6366f1;
    }

    .visibility-options .form-check-label {
        color: #e5e7eb;
        font-weight: 600;
    }

    .upload-info {
        margin-top: 1.5rem;
        display: flex;
        gap: 0.75rem;
        background: rgba(99, 102, 241, 0.12);
        border: 1px solid rgba(99, 102, 241, 0.25);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        color: #c7d2fe;
        align-items: flex-start;
    }

    .upload-info i {
        font-size: 1.4rem;
        color: #a5b4fc;
        margin-top: 0.15rem;
    }

    .upload-actions {
        margin-top: 2rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
    }

    .upload-actions .btn-primary {
        padding: 0.75rem 2.5rem;
        border-radius: 999px;
        font-weight: 600;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        border: none;
        box-shadow: 0 12px 28px rgba(99, 102, 241, 0.35);
    }

    .upload-note {
        color: #94a3b8;
        font-size: 0.9rem;
    }

    .progress {
        border-radius: 999px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.08);
    }

    .progress-bar {
        background: linear-gradient(90deg, #6366f1, #a855f7);
    }

    @media (max-width: 992px) {
        .upload-layout {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .upload-card__body {
            padding: 1.5rem;
        }

        .upload-actions {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('userVideoUploadForm');
    const progressWrap = document.getElementById('userUploadProgress');
    const progressBar = document.getElementById('userUploadProgressBar');
    const progressText = document.getElementById('userUploadProgressText');

    if (!form) {
        return;
    }

    form.addEventListener('submit', function (event) {
        event.preventDefault();

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const actionUrl = form.getAttribute('action') || window.location.href;
        const xhr = new XMLHttpRequest();
        xhr.open(form.method.toUpperCase(), actionUrl);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        progressWrap.classList.remove('d-none');
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', '0');
        progressText.textContent = 'Uploading... 0%';

        xhr.upload.addEventListener('progress', function (e) {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percent + '%';
                progressBar.setAttribute('aria-valuenow', String(percent));
                progressText.textContent = 'Uploading... ' + percent + '%';
            }
        });

        xhr.onload = function () {
            if (xhr.status >= 200 && xhr.status < 300) {
                const contentType = xhr.getResponseHeader('Content-Type') || '';
                if (contentType.includes('application/json')) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data.redirect) {
                            window.location = data.redirect;
                            return;
                        }
                    } catch (e) {
                        // ignore JSON parse errors
                    }
                } else {
                    document.open();
                    document.write(xhr.responseText);
                    document.close();
                    return;
                }
                window.location = xhr.responseURL || form.action;
            } else {
                try {
                    const data = JSON.parse(xhr.responseText);
                    if (data.error) {
                        progressText.textContent = data.error;
                        return;
                    }
                } catch (e) {
                    // ignore JSON parse errors
                }
                progressText.textContent = 'Upload failed. Please try again.';
            }
        };

        xhr.onerror = function () {
            progressText.textContent = 'Network error. Please try again.';
        };

        xhr.send(new FormData(form));
    });
});
</script>
{% endblock %}
