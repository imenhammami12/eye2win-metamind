{% extends 'admin_layout.html.twig' %}

{% block title %}Edit Planning{% endblock %}
{% block page_title %}Edit Session{% endblock %}

{% block body %}
<div class="mb-3 fade-in">
    <a href="{{ path('admin_planning_index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Back to List
    </a>
</div>

<div class="row justify-content-center fade-in" style="animation-delay: 0.1s;">
    <div class="col-lg-8">
        <div class="table-card">
            {# Header Gradient matching Create (Blue) #}
            <div class="card-header-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem; border-radius: 16px 16px 0 0;">
                <h5 class="mb-0 text-white"><i class="bi bi-pencil-square me-2"></i>Edit Session Details</h5>
            </div>
            
            {{ form_start(form, {'attr': {'class': 'p-4', 'id': 'editPlanningForm', 'novalidate': 'novalidate'}}) }}
                
                <div class="row g-4">
                    {# Image Section #}
                    <div class="col-12 text-center mb-4">
                        <div class="image-preview-container mb-2" id="imagePreviewContainer" style="{{ planning.image ? 'display: block;' : 'display: none;' }}">
                            <img id="imagePreview" 
                                 src="{{ planning.image ? asset('uploads/planning/' ~ planning.image) : '#' }}" 
                                 alt="Preview" 
                                 class="img-fluid rounded shadow-sm" 
                                 style="max-height: 200px; border: 2px solid #667eea;">
                        </div>
                        <div class="upload-area p-4 border rounded border-dashed cursor-pointer hover-bg-light transition-all" 
                             style="border-style: dashed !important; border-color: #dee2e6;"
                             onclick="document.getElementById('{{ form.image.vars.id }}').click()">
                            <i class="bi bi-cloud-upload display-4 text-primary mb-3"></i>
                            <p class="mb-0 text-muted fw-bold">Click to update cover image</p>
                            <p class="small text-muted mb-0">(JPG, PNG, WEBP - Max 2MB)</p>
                        </div>
                        <div class="d-none">
                            {{ form_widget(form.image, {'attr': {'accept': 'image/*', 'onchange': 'readURL(this)'}}) }}
                        </div>
                        {{ form_errors(form.image) }}
                    </div>

                    {# Type & Level #}
                    <div class="col-md-6 form-group-enhanced">
                        <label class="form-label fw-bold">
                            <i class="bi bi-controller me-1"></i>Game Type 
                            <span class="required-indicator" style="color: #fa709a;">*</span>
                        </label>
                        {{ form_widget(form.type) }}
                        {{ form_errors(form.type) }}
                    </div>
                    
                    <div class="col-md-6 form-group-enhanced">
                        <label class="form-label fw-bold">
                            <i class="bi bi-bar-chart me-1"></i>Skill Level 
                            <span class="required-indicator" style="color: #fa709a;">*</span>
                        </label>
                        {{ form_widget(form.level) }}
                        {{ form_errors(form.level) }}
                    </div>

                    {# Location Mode #}
                    <div class="col-12 form-group-enhanced">
                        <label class="form-label fw-bold">
                            <i class="bi bi-geo me-1"></i>Location Mode 
                            <span class="required-indicator" style="color: #fa709a;">*</span>
                        </label>
                        <div class="d-flex gap-3 mt-2">
                            {% for child in form.mode %}
                                <div class="form-check custom-radio-card">
                                    {{ form_widget(child, {'attr': {'class': 'form-check-input mode-selector'}}) }}
                                    {{ form_label(child, null, {'label_attr': {'class': 'form-check-label fw-medium'}}) }}
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    {# Location Details (Conditional) #}
                    <div class="col-12" id="locationDetailsGroup" style="display: none;">
                        <label class="form-label fw-bold">
                            <i class="bi bi-geo-alt me-1"></i>Location Details 
                            <span class="required-indicator" style="color: #fa709a;">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-pin-map"></i></span>
                            {{ form_widget(form.localisation) }}
                        </div>
                        <div id="map-picker" style="display: none;"></div>
                        <small class="text-muted">Specify the address or pick it on the map.</small>
                        {{ form_errors(form.localisation) }}
                    </div>

                    {# Date & Time #}
                    <div class="col-md-6 form-group-enhanced">
                        <label class="form-label fw-bold">
                            <i class="bi bi-calendar3 me-1"></i>Date 
                            <span class="required-indicator" style="color: #fa709a;">*</span>
                        </label>
                        {{ form_widget(form.date) }}
                        {{ form_errors(form.date) }}
                    </div>

                    <div class="col-md-6 form-group-enhanced">
                        <label class="form-label fw-bold">
                            <i class="bi bi-clock me-1"></i>Time 
                            <span class="required-indicator" style="color: #fa709a;">*</span>
                        </label>
                        {{ form_widget(form.time) }}
                        {{ form_errors(form.time) }}
                    </div>

                    {# Description #}
                    <div class="col-12 form-group-enhanced">
                        <label class="form-label fw-bold">
                            <i class="bi bi-file-text me-1"></i>Description 
                            <span class="required-indicator" style="color: #fa709a;">*</span>
                        </label>
                        {{ form_widget(form.description) }}
                        {{ form_errors(form.description) }}
                    </div>

                    {# Partner Toggle #}
                    <div class="col-12">
                        <div class="form-check form-switch p-3 rounded border border-secondary" style="background: rgba(255, 255, 255, 0.05);">
                            {{ form_widget(form.needPartner) }}
                            <label class="form-check-label fw-bold ms-2 text-white" for="{{ form.needPartner.vars.id }}">
                                <i class="bi bi-people me-2"></i>Looking for partners?
                            </label>
                            <div class="small text-muted ms-4 mt-1">Enable this if you need other players to join.</div>
                        </div>
                    </div>
                </div>

                {# Action Buttons #}
                <div class="mt-5 d-flex gap-2 border-top pt-4">
                    <button type="submit" class="btn btn-success px-4" id="submitBtn">
                        <i class="bi bi-check-lg me-2"></i>Update Session
                    </button>
                    <a href="{{ path('admin_planning_index') }}" class="btn btn-outline-secondary px-4">
                        <i class="bi bi-x-lg me-2"></i>Cancel
                    </a>
                </div>

            {{ form_end(form) }}
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
</script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('editPlanningForm');
        const locationGroup = document.getElementById('locationDetailsGroup');
        const locationInput = document.getElementById('{{ form.localisation.vars.id }}');
        const modeRadios = document.querySelectorAll('.mode-selector');
        
        // --- Leaflet Integration ---
        let map = null;
        let marker = null;

        async function initMap() {
            if (map !== null) return;

            setTimeout(async () => {
                const mapContainer = document.getElementById('map-picker');
                mapContainer.style.display = 'block';

                // Default coordinates
                let lat = 36.8065;
                let lng = 10.1815;

                // If existing address, try to locate it
                if (locationInput.value && locationInput.value !== 'Online') {
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationInput.value)}`);
                        const data = await response.json();
                        if (data && data.length > 0) {
                            lat = parseFloat(data[0].lat);
                            lng = parseFloat(data[0].lon);
                        }
                    } catch (e) { console.warn("Initial geocoding failed"); }
                }

                map = L.map('map-picker').setView([lat, lng], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; contributors'
                }).addTo(map);

                marker = L.marker([lat, lng], { draggable: true }).addTo(map);

                setTimeout(() => { map.invalidateSize(); }, 200);

                map.on('click', function(e) {
                    const { lat, lng } = e.latlng;
                    marker.setLatLng([lat, lng]);
                    reverseGeocode(lat, lng);
                });

                marker.on('dragend', function(e) {
                    const { lat, lng } = marker.getLatLng();
                    reverseGeocode(lat, lng);
                });
            }, 300);
        }

        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                if (data.display_name) {
                    locationInput.value = data.display_name;
                    locationInput.classList.add('is-valid');
                }
            } catch (error) {
                locationInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        }

        // Mode Toggle Logic
        function updateLocationVisibility() {
            const selectedMode = Array.from(modeRadios).find(r => r.checked)?.value;

            if (selectedMode === 'onsite') {
                locationGroup.style.display = 'block';
                locationGroup.style.animation = 'slideInUp 0.3s ease';
                locationInput.required = true;
                if(locationInput.value === 'Online') locationInput.value = '';
                initMap();
            } else {
                locationGroup.style.display = 'none';
                locationInput.required = false;
                locationInput.value = 'Online';
            }
        }

        modeRadios.forEach(radio => radio.addEventListener('change', updateLocationVisibility));
        
        // Initialize
        updateLocationVisibility();

        // Image Preview (Rest of existing logic)
        window.readURL = function(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreviewContainer').style.display = 'block';
                    document.querySelector('.upload-area').style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            }
        };

        // Submit Button Loading State
        form.addEventListener('submit', function(e) {
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
        });

        // Real-time validation
        form.querySelectorAll('.form-control, .form-select').forEach(input => {
            input.addEventListener('blur', function() {
                if (this.checkValidity()) {
                    this.classList.add('is-valid');
                    this.classList.remove('is-invalid');
                } else {
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                }
            });
        });
    });
</script>

<style>
    /* Leaflet Map Styles */
    #map-picker {
        height: 300px;
        width: 100%;
        border-radius: 12px;
        border: 2px solid rgba(139, 92, 246, 0.2);
        margin-top: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        z-index: 1;
    }

    .leaflet-container {
        font-family: 'Inter', sans-serif;
    }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{% endblock %}
