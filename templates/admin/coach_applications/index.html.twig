{% extends 'admin_layout.html.twig' %}

{% block title %}Coach Applications{% endblock %}
{% block page_title %}Coach Applications Management{% endblock %}

{% block body %}
{# Stats Row #}
<div class="row g-4 mb-4 fade-in">
    <div class="col-md-4">
        <div class="stat-card">
            <div class="stat-card-icon" style="background: linear-gradient(135deg, #ffa751, #ffe259);">
                <i class="bi bi-clock text-white"></i>
            </div>
            <div class="stat-card-title">Pending</div>
            <div class="stat-card-value">{{ stats.pending }}</div>
            <a href="{{ path('admin_coach_applications_index', {status: 'PENDING'}) }}" class="btn btn-sm btn-outline-primary mt-2">
                <i class="bi bi-eye me-1"></i>View
            </a>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card">
            <div class="stat-card-icon" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
                <i class="bi bi-check-circle text-white"></i>
            </div>
            <div class="stat-card-title">Approved</div>
            <div class="stat-card-value">{{ stats.approved }}</div>
            <a href="{{ path('admin_coach_applications_index', {status: 'APPROVED'}) }}" class="btn btn-sm btn-outline-success mt-2">
                <i class="bi bi-eye me-1"></i>View
            </a>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card">
            <div class="stat-card-icon" style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f);">
                <i class="bi bi-x-circle text-white"></i>
            </div>
            <div class="stat-card-title">Rejected</div>
            <div class="stat-card-value">{{ stats.rejected }}</div>
            <a href="{{ path('admin_coach_applications_index', {status: 'REJECTED'}) }}" class="btn btn-sm btn-outline-danger mt-2">
                <i class="bi bi-eye me-1"></i>View
            </a>
        </div>
    </div>
</div>

{# Advanced Filters Card #}
<div class="table-card mb-4 fade-in" style="animation-delay: 0.1s;">
    <div class="table-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filters</h5>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="true">
            <i class="bi bi-chevron-down"></i>
        </button>
    </div>

    <div class="collapse show" id="filterCollapse">
        <form method="get" class="p-3" id="filterForm">
            <div class="row g-3">

                {# ── Search Bar with Voice Button ── #}
                <div class="col-md-6">
                    <label class="form-label">
                        <i class="bi bi-search me-1"></i>Search
                    </label>
                    <div class="input-group voice-input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text"
                               name="search"
                               class="form-control"
                               placeholder="Name, username, email, certifications..."
                               value="{{ search }}"
                               id="searchInput">

                        {# Mic button — shown via JS if supported #}
                        <button type="button"
                                id="voiceMicBtn"
                                class="btn btn-outline-secondary voice-mic-btn"
                                title="Search by voice"
                                style="display:none;">
                            <i class="bi bi-mic-fill"></i>
                        </button>

                        {% if search %}
                            <button type="button" class="btn btn-outline-secondary"
                                    onclick="document.getElementById('searchInput').value=''; document.getElementById('filterForm').submit();">
                                <i class="bi bi-x"></i>
                            </button>
                        {% endif %}
                    </div>

                    {# Listening indicator #}
                    <div id="voiceStatus" class="voice-status d-none">
                        <span class="voice-pulse"></span>
                        <span id="voiceStatusText">Listening… speak now</span>
                    </div>

                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>Search in name, username, email, certifications, and experience
                    </small>
                </div>

                {# Status Filter #}
                <div class="col-md-3">
                    <label class="form-label">
                        <i class="bi bi-filter me-1"></i>Status
                    </label>
                    <select name="status" class="form-select" onchange="this.form.submit()">
                        <option value="">All Statuses</option>
                        {% for status in applicationStatuses %}
                            <option value="{{ status.value }}" {{ statusFilter == status.value ? 'selected' : '' }}>
                                {{ status.label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                {# Sort By #}
                <div class="col-md-3">
                    <label class="form-label">
                        <i class="bi bi-sort-down me-1"></i>Sort By
                    </label>
                    <div class="input-group">
                        <select name="sort_by" class="form-select" onchange="this.form.submit()">
                            <option value="submittedAt" {{ sortBy == 'submittedAt' ? 'selected' : '' }}>Submitted Date</option>
                            <option value="reviewedAt"  {{ sortBy == 'reviewedAt'  ? 'selected' : '' }}>Reviewed Date</option>
                            <option value="status"      {{ sortBy == 'status'      ? 'selected' : '' }}>Status</option>
                        </select>
                        <select name="sort_order" class="form-select" style="max-width: 100px;" onchange="this.form.submit()">
                            <option value="DESC" {{ sortOrder == 'DESC' ? 'selected' : '' }}>↓ DESC</option>
                            <option value="ASC"  {{ sortOrder == 'ASC'  ? 'selected' : '' }}>↑ ASC</option>
                        </select>
                    </div>
                </div>

                {# Date Range #}
                <div class="col-md-6">
                    <label class="form-label">
                        <i class="bi bi-calendar-range me-1"></i>Submission Date Range
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">From</span>
                        <input type="date" name="date_from" class="form-control" value="{{ dateFrom }}" onchange="this.form.submit()">
                        <span class="input-group-text">To</span>
                        <input type="date" name="date_to"   class="form-control" value="{{ dateTo }}"   onchange="this.form.submit()">
                    </div>
                </div>

                {# Action Buttons #}
                <div class="col-md-6 d-flex align-items-end gap-2">
                    {% if statusFilter or search or dateFrom or dateTo %}
                        <a href="{{ path('admin_coach_applications_index') }}" class="btn btn-outline-secondary flex-fill">
                            <i class="bi bi-x-lg me-1"></i>Clear All Filters
                        </a>
                    {% endif %}
                    <button type="submit" class="btn btn-primary flex-fill">
                        <i class="bi bi-funnel me-2"></i>Apply Filters
                    </button>
                    <a href="{{ path('admin_coaches_list') }}" class="btn btn-success flex-fill">
                        <i class="bi bi-award me-2"></i>View Coaches
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

{# Results Summary #}
<div class="mb-3 fade-in" style="animation-delay: 0.15s;">
    <h6 class="text-muted mb-0">
        <i class="bi bi-info-circle me-2"></i>
        Found <strong>{{ pagination.getTotalItemCount }}</strong> application{{ pagination.getTotalItemCount != 1 ? 's' : '' }}
        {% if statusFilter or search or dateFrom or dateTo %}
            <span class="badge bg-primary">Filtered</span>
        {% endif %}
    </h6>
</div>

{# Applications Table #}
<div class="table-card fade-in" style="animation-delay: 0.2s;">
    <div class="table-header">
        <h5><i class="bi bi-clipboard-check me-2"></i>Applications List ({{ pagination.getTotalItemCount }})</h5>
    </div>

    <div class="table-responsive">
        <table class="custom-table table">
            <thead>
                <tr>
                    <th>Photo</th>
                    <th>Applicant</th>
                    <th>Email</th>
                    <th>Submitted</th>
                    <th>Status</th>
                    <th>Reviewed</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for application in pagination %}
                    <tr class="fade-in" style="animation-delay: {{ loop.index * 0.05 }}s;">
                        <td>
                            {% if application.user.profilePicture %}
                                <img src="{{ asset('uploads/profiles/' ~ application.user.profilePicture) }}"
                                     alt="{{ application.user.username }}"
                                     class="user-avatar-table" loading="lazy">
                            {% else %}
                                <div class="user-avatar-placeholder">
                                    {{ application.user.username|slice(0, 2)|upper }}
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ path('admin_users_show', {id: application.user.id}) }}" class="text-decoration-none" style="color: #43e97b;">
                                <strong>{{ application.user.fullName ?? application.user.username }}</strong>
                            </a>
                            <br>
                            <small class="text-muted"><i class="bi bi-at"></i>{{ application.user.username }}</small>
                        </td>
                        <td>
                            <a href="mailto:{{ application.user.email }}" class="text-decoration-none" style="color: #4facfe;">
                                <i class="bi bi-envelope me-1"></i>
                                <span style="display:inline-block; max-width:180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; vertical-align:middle;">{{ application.user.email }}</span>
                            </a>
                        </td>
                        <td>
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>{{ application.submittedAt|date('M d, Y') }}<br>
                                <i class="bi bi-clock me-1"></i>{{ application.submittedAt|date('h:i A') }}
                            </small>
                        </td>
                        <td>
                            <span class="badge bg-{{ application.status.badgeClass }}">{{ application.status.label }}</span>
                        </td>
                        <td>
                            {% if application.reviewedAt %}
                                <small class="text-muted">
                                    <i class="bi bi-check2 me-1"></i>{{ application.reviewedAt|date('M d, Y') }}<br>
                                    <i class="bi bi-clock me-1"></i>{{ application.reviewedAt|date('h:i A') }}
                                </small>
                            {% else %}
                                <small class="text-muted"><i class="bi bi-dash-circle me-1"></i>Not reviewed</small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{{ path('admin_coach_applications_show', {id: application.id}) }}"
                                   class="btn btn-sm btn-info" title="View Details" data-bs-toggle="tooltip">
                                    <i class="bi bi-eye"></i>
                                </a>
                                {% if application.status.value != 'APPROVED' %}
                                    <button type="button" class="btn btn-sm btn-success"
                                            onclick="window.location.href='{{ path('admin_coach_applications_show', {id: application.id}) }}#approve-section'"
                                            title="Approve" data-bs-toggle="tooltip">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                {% endif %}
                                {% if application.status.value != 'REJECTED' %}
                                    <button type="button" class="btn btn-sm btn-danger"
                                            onclick="window.location.href='{{ path('admin_coach_applications_show', {id: application.id}) }}#reject-section'"
                                            title="Reject" data-bs-toggle="tooltip">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-5">
                            <div class="empty-state">
                                <i class="bi bi-inbox" style="font-size: 64px; opacity: 0.2;"></i>
                                <h4 class="mt-3 mb-2">No Applications Found</h4>
                                {% if statusFilter or search or dateFrom or dateTo %}
                                    <p class="text-muted">Try adjusting your filters</p>
                                    <a href="{{ path('admin_coach_applications_index') }}" class="btn btn-sm btn-outline-primary mt-2">
                                        <i class="bi bi-x-lg me-1"></i>Clear Filters
                                    </a>
                                {% else %}
                                    <p class="text-muted">Coach applications will appear here</p>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{# Pagination #}
{% if pagination.getTotalItemCount > 20 %}
<div class="d-flex justify-content-between align-items-center mt-4 fade-in" style="animation-delay: 0.3s;">
    <div class="text-muted">
        Showing {{ ((pagination.currentPageNumber - 1) * 20) + 1 }}
        to {{ min(pagination.currentPageNumber * 20, pagination.getTotalItemCount) }}
        of {{ pagination.getTotalItemCount }} entries
    </div>
    <div class="pagination-wrapper">
        {{ knp_pagination_render(pagination, '@KnpPaginator/Pagination/bootstrap_v5_pagination.html.twig', {}, {
            'status': statusFilter, 'search': search,
            'date_from': dateFrom, 'date_to': dateTo,
            'sort_by': sortBy, 'sort_order': sortOrder
        }) }}
    </div>
</div>
{% endif %}
{% endblock %}

{% block javascripts %}
<style>
/* ── Voice mic button inside input-group ── */
.voice-mic-btn {
    transition: color .2s, background .2s, border-color .2s;
}
.voice-mic-btn.is-listening {
    color: #ff4d4d !important;
    border-color: #ff4d4d !important;
    background: rgba(255,77,77,0.1) !important;
    animation: mic_glow 1.2s ease-in-out infinite;
}
@keyframes mic_glow {
    0%,100% { box-shadow: 0 0 0 0   rgba(255,77,77,.4); }
    50%      { box-shadow: 0 0 0 6px rgba(255,77,77,0);  }
}

/* Status row */
.voice-status {
    display: flex;
    align-items: center;
    gap: .4rem;
    margin-top: .3rem;
    font-size: .75rem;
    color: #ff7070;
}
.voice-pulse {
    display: inline-block;
    width: 7px; height: 7px;
    border-radius: 50%;
    background: #ff4d4d;
    animation: v_blink 1s ease-in-out infinite;
    flex-shrink: 0;
}
@keyframes v_blink { 0%,100%{opacity:1} 50%{opacity:.1} }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {

    /* ── Tooltips ── */
    [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        .forEach(el => new bootstrap.Tooltip(el, { delay: { show: 300, hide: 100 } }));

    /* ── Row hover ── */
    document.querySelectorAll('.custom-table tbody tr').forEach(row => {
        row.addEventListener('mouseenter', () => row.style.transform = 'translateX(2px)');
        row.addEventListener('mouseleave', () => row.style.transform = 'translateX(0)');
    });

    /* ════════════════════════════════════════════════════
       Voice Search
       1. Web Speech API  (Chrome / Edge / Opera GX)
       2. Fallback: MediaRecorder → Symfony → Whisper HF
       ════════════════════════════════════════════════════ */
    const micBtn     = document.getElementById('voiceMicBtn');
    const statusDiv  = document.getElementById('voiceStatus');
    const statusText = document.getElementById('voiceStatusText');
    const searchInp  = document.getElementById('searchInput');
    const filterForm = document.getElementById('filterForm');

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const hasNativeSTT      = !!SpeechRecognition;
    const hasMediaRecorder  = !!(navigator.mediaDevices && window.MediaRecorder);

    if (hasNativeSTT || hasMediaRecorder) {
        micBtn.style.display = 'inline-flex';
    }

    let isListening   = false;
    let recognition   = null;
    let mediaRecorder = null;
    let audioChunks   = [];
    let micStream     = null;

    function setListening(on) {
        isListening = on;
        if (on) {
            micBtn.classList.add('is-listening');
            micBtn.innerHTML = '<i class="bi bi-stop-fill"></i>';
            statusDiv.classList.remove('d-none');
            statusDiv.querySelector('.voice-pulse').style.background = '#ff4d4d';
            statusText.textContent = 'Listening… speak now';
        } else {
            micBtn.classList.remove('is-listening');
            micBtn.innerHTML = '<i class="bi bi-mic-fill"></i>';
            statusDiv.classList.add('d-none');
        }
    }

    function applyAndSubmit(text) {
        const clean = text.trim();
        if (!clean) return;
        searchInp.value = clean;
        setTimeout(() => filterForm.submit(), 600);
    }

    /* ── Method 1: Native Web Speech API ── */
    function startNativeSTT() {
        recognition      = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.continuous     = false;
        recognition.interimResults = true;

        recognition.onstart = () => setListening(true);

        recognition.onresult = (e) => {
            let interim = '', final = '';
            for (let i = e.resultIndex; i < e.results.length; i++) {
                const t = e.results[i][0].transcript;
                e.results[i].isFinal ? (final += t) : (interim += t);
            }
            searchInp.value = final || interim;
            if (final) recognition.stop();
        };

        recognition.onerror = (e) => {
            setListening(false);
            if (e.error === 'not-allowed') alert('Microphone access denied.');
        };

        recognition.onend = () => {
            const val = searchInp.value.trim();
            setListening(false);
            if (val) setTimeout(() => filterForm.submit(), 500);
        };

        recognition.start();
    }

    /* ── Method 2: MediaRecorder → Symfony → Whisper ── */
    const TRANSCRIBE_URL = '{{ path("app_speech_transcribe") }}';

    async function startMediaSTT() {
        try {
            micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        } catch {
            alert('Microphone access denied.');
            return;
        }

        audioChunks = [];
        const mime  = ['audio/webm;codecs=opus', 'audio/webm', 'audio/ogg', '']
            .find(t => t === '' || MediaRecorder.isTypeSupported(t));

        mediaRecorder = new MediaRecorder(micStream, mime ? { mimeType: mime } : {});
        mediaRecorder.ondataavailable = e => { if (e.data?.size > 0) audioChunks.push(e.data); };

        mediaRecorder.onstop = async () => {
            micStream.getTracks().forEach(t => t.stop());
            micStream = null;
            setListening(false);

            // Show transcribing state
            statusDiv.classList.remove('d-none');
            statusDiv.querySelector('.voice-pulse').style.background = '#ffc107';
            statusText.textContent = 'Transcribing…';

            const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
            audioChunks   = [];
            mediaRecorder = null;

            const formData = new FormData();
            formData.append('audio', blob, 'search.webm');

            try {
                const res = await fetch(TRANSCRIBE_URL, {
                    method     : 'POST',
                    body       : formData,
                    credentials: 'same-origin',
                    headers    : { 'X-Requested-With': 'XMLHttpRequest' },
                });

                statusDiv.classList.add('d-none');

                const ct = res.headers.get('content-type') || '';
                if (!ct.includes('application/json')) {
                    alert('Session expired. Please refresh the page.');
                    return;
                }

                const data = await res.json();
                if (res.ok && data.text) {
                    applyAndSubmit(data.text);
                } else {
                    alert('Could not transcribe. Please try again.');
                }
            } catch (err) {
                statusDiv.classList.add('d-none');
                console.error(err);
                alert('Server error. Check your connection.');
            }
        };

        mediaRecorder.start(250);
        setListening(true);
    }

    /* ── Mic button click ── */
    micBtn.addEventListener('click', () => {
        if (isListening) {
            if (recognition)   recognition.stop();
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            setListening(false);
            return;
        }
        hasNativeSTT ? startNativeSTT() : startMediaSTT();
    });
});
</script>
{% endblock %}
