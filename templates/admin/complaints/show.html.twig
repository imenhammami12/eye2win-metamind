{% extends 'admin_layout.html.twig' %}

{% block title %}Complaint #{{ complaint.id }}{% endblock %}
{% block page_title %}Complaint Details{% endblock %}

{% block body %}
<div class="mb-4">
    <a href="{{ path('admin_complaints_index') }}" class="btn btn-outline-light">
        <i class="bi bi-arrow-left"></i> Back to Complaints
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Complaint Details Card -->
        <div class="table-card mb-4">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h3 class="mb-2">{{ complaint.subject }}</h3>
                    <div class="d-flex gap-2 flex-wrap">
                        <span class="badge bg-{{ complaint.status.badgeClass }}">
                            <i class="{{ complaint.status.icon }}"></i>
                            {{ complaint.status.label }}
                        </span>
                        <span class="badge bg-{{ complaint.priority.badgeClass }}">
                            <i class="{{ complaint.priority.icon }}"></i>
                            {{ complaint.priority.label }}
                        </span>
                        <span class="badge bg-secondary">
                            <i class="{{ complaint.category.icon }}"></i>
                            {{ complaint.category.label }}
                        </span>
                    </div>
                </div>
                <div class="text-end">
                    <small class="text-muted">Complaint #{{ complaint.id }}</small>
                </div>
            </div>

            <div class="complaint-section">
                <h5><i class="bi bi-file-text"></i> Description</h5>
                <p class="text-white-50">{{ complaint.description|nl2br }}</p>
            </div>

            {% if complaint.attachmentPath %}
            <div class="complaint-section">
                <h5><i class="bi bi-paperclip"></i> Attachment</h5>
                <a href="{{ asset('uploads/complaints/' ~ complaint.attachmentPath) }}" 
                   class="btn btn-sm btn-outline-light" 
                   target="_blank">
                    <i class="bi bi-download"></i> Download Attachment
                </a>
            </div>
            {% endif %}

            {% if complaint.adminResponse %}
            <div class="complaint-section">
                <h5><i class="bi bi-reply"></i> Admin Response</h5>
                <div class="alert alert-info">
                    {{ complaint.adminResponse|nl2br }}
                </div>
            </div>
            {% endif %}

            {% if complaint.resolutionNotes %}
            <div class="complaint-section">
                <h5><i class="bi bi-check-circle"></i> Resolution Notes</h5>
                <div class="alert alert-success">
                    {{ complaint.resolutionNotes|nl2br }}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Admin Response Form -->
        {% if not complaint.isResolved %}
        <div class="table-card mb-4">
            <h5 class="mb-3"><i class="bi bi-reply"></i> Add Response</h5>
            <form method="post" action="{{ path('admin_complaints_respond', {id: complaint.id}) }}">
                <input type="hidden" name="_token" value="{{ csrf_token('respond-' ~ complaint.id) }}">
                
                <div class="mb-3">
                    <textarea class="form-control" 
                              name="response" 
                              rows="4" 
                              placeholder="Type your response to the user..."
                              required></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-send"></i> Send Response
                </button>
            </form>
        </div>

        <!-- Resolve Form -->
        <div class="table-card">
            <h5 class="mb-3"><i class="bi bi-check-circle"></i> Resolve Complaint</h5>
            <form method="post" action="{{ path('admin_complaints_resolve', {id: complaint.id}) }}">
                <input type="hidden" name="_token" value="{{ csrf_token('resolve-' ~ complaint.id) }}">
                
                <div class="mb-3">
                    <label class="form-label">Resolution Notes</label>
                    <textarea class="form-control" 
                              name="resolution_notes" 
                              rows="3" 
                              placeholder="Describe how this complaint was resolved..."
                              required></textarea>
                </div>
                
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-circle"></i> Mark as Resolved
                </button>
            </form>
        </div>
        {% endif %}
    </div>

    <div class="col-lg-4">
        <!-- Info Sidebar -->
        <div class="table-card mb-4">
            <h5 class="mb-3"><i class="bi bi-info-circle"></i> Information</h5>
            
            <div class="info-item">
                <strong>Submitted By:</strong>
                <div>
                    <a href="{{ path('admin_users_show', {id: complaint.submittedBy.id}) }}" 
                       class="text-decoration-none">
                        <i class="bi bi-person"></i> {{ complaint.submittedBy.username }}
                    </a>
                </div>
            </div>

            <div class="info-item">
                <strong>Assigned To:</strong>
                <div>
                    {% if complaint.assignedTo %}
                        <i class="bi bi-person-check text-success"></i>
                        {{ complaint.assignedTo.username }}
                    {% else %}
                        <span class="text-muted">
                            <i class="bi bi-person-x"></i> Not assigned
                        </span>
                    {% endif %}
                </div>
            </div>

            <div class="info-item">
                <strong>Created:</strong>
                <div>{{ complaint.createdAt|date('d/m/Y H:i') }}</div>
            </div>

            {% if complaint.updatedAt %}
            <div class="info-item">
                <strong>Last Updated:</strong>
                <div>{{ complaint.updatedAt|date('d/m/Y H:i') }}</div>
            </div>
            {% endif %}

            {% if complaint.resolvedAt %}
            <div class="info-item">
                <strong>Resolved:</strong>
                <div>{{ complaint.resolvedAt|date('d/m/Y H:i') }}</div>
            </div>
            {% endif %}
        </div>

        <!-- Actions -->
        <div class="table-card mb-4">
            <h5 class="mb-3"><i class="bi bi-gear"></i> Actions</h5>
            
            <!-- Assign -->
            <form method="post" action="{{ path('admin_complaints_assign', {id: complaint.id}) }}" class="mb-3">
                <input type="hidden" name="_token" value="{{ csrf_token('assign-complaint-' ~ complaint.id) }}">
                <label class="form-label">Assign to Admin:</label>
                <div class="input-group">
                    <select class="form-select" name="admin_id" required>
                        <option value="">Select Admin...</option>
                        <option value="unassign">Unassign</option>
                        {% if admins is defined and admins is not empty %}
                            {% for admin in admins %}
                            <option value="{{ admin.id }}" 
                                    {% if complaint.assignedTo and complaint.assignedTo.id == admin.id %}selected{% endif %}>
                                {{ admin.username }}
                                {% if admin.email %}({{ admin.email }}){% endif %}
                            </option>
                            {% endfor %}
                        {% else %}
                            <option disabled>No administrators found</option>
                        {% endif %}
                    </select>
                    <button type="submit" class="btn btn-primary">Assign</button>
                </div>
                {% if admins is not defined or admins is empty %}
                    <small class="text-warning d-block mt-1">
                        <i class="bi bi-exclamation-triangle"></i> 
                        No administrators available. Please create admin users first.
                    </small>
                {% endif %}
            </form>

            <!-- Change Status -->
            <form method="post" action="{{ path('admin_complaints_update_status', {id: complaint.id}) }}" class="mb-3">
                <input type="hidden" name="_token" value="{{ csrf_token('update-status-' ~ complaint.id) }}">
                <label class="form-label">Change Status:</label>
                <div class="input-group">
                    <select class="form-select" name="status" required>
                        <option value="PENDING" {% if complaint.status.value == 'PENDING' %}selected{% endif %}>Pending</option>
                        <option value="IN_PROGRESS" {% if complaint.status.value == 'IN_PROGRESS' %}selected{% endif %}>In Progress</option>
                        <option value="RESOLVED" {% if complaint.status.value == 'RESOLVED' %}selected{% endif %}>Resolved</option>
                        <option value="CLOSED" {% if complaint.status.value == 'CLOSED' %}selected{% endif %}>Closed</option>
                        <option value="REJECTED" {% if complaint.status.value == 'REJECTED' %}selected{% endif %}>Rejected</option>
                    </select>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>

            <!-- Change Priority -->
            <form method="post" action="{{ path('admin_complaints_update_priority', {id: complaint.id}) }}" class="mb-3">
                <input type="hidden" name="_token" value="{{ csrf_token('update-priority-' ~ complaint.id) }}">
                <label class="form-label">Change Priority:</label>
                <div class="input-group">
                    <select class="form-select" name="priority" required>
                        <option value="LOW" {% if complaint.priority.value == 'LOW' %}selected{% endif %}>Low</option>
                        <option value="MEDIUM" {% if complaint.priority.value == 'MEDIUM' %}selected{% endif %}>Medium</option>
                        <option value="HIGH" {% if complaint.priority.value == 'HIGH' %}selected{% endif %}>High</option>
                        <option value="URGENT" {% if complaint.priority.value == 'URGENT' %}selected{% endif %}>Urgent</option>
                    </select>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>

            <hr>

            <!-- Delete -->
            <form method="post" action="{{ path('admin_complaints_delete', {id: complaint.id}) }}" 
                  onsubmit="return confirm('Are you sure you want to delete this complaint? This action cannot be undone.');">
                <input type="hidden" name="_token" value="{{ csrf_token('delete-' ~ complaint.id) }}">
                <button type="submit" class="btn btn-danger w-100">
                    <i class="bi bi-trash"></i> Delete Complaint
                </button>
            </form>
        </div>
    </div>
</div>

<style>
.complaint-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.complaint-section:last-child {
    border-bottom: none;
}

.complaint-section h5 {
    margin-bottom: 1rem;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 600;
}

.info-item {
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.info-item:last-child {
    border-bottom: none;
}

.info-item strong {
    display: block;
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}
</style>
{% endblock %}
