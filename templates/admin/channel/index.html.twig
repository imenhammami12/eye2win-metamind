{% extends 'admin_layout.html.twig' %}

{% block title %}
    Channels Management
{% endblock %}

{% block page_title %}
    Channels Management
{% endblock %}

{% block body %}
    <style>
        .sort-icons{
            display:inline-flex;
            flex-direction:column;
            line-height:0.65;
            font-size:0.7rem;
            margin-left:.25rem;
            vertical-align:middle;
        }
        .sort-icons span { opacity:.35; }
        .sort-icons span.active { opacity:1; }
    </style>

    {# ✅ Filters & Search #}
    <div class="table-card mb-4 fade-in">
        <div class="table-header">
            <h5>
                <i class="bi bi-funnel me-2"></i>
                Filters & Search
            </h5>
        </div>

        <form id="channelsFiltersForm" method="get" action="{{ path('admin_channels_index') }}" class="p-3">

            <div class="row g-3">

                <div class="col-md-4">
                    <label class="form-label">
                        <i class="bi bi-search me-1"></i>Search
                    </label>
                    <div class="search-bar">
                        <i class="search-icon bi bi-search"></i>
                        <input
                                type="text"
                                name="q"
                                class="form-control"
                                placeholder="Name, game, createdBy..."
                                value="{{ q }}"
                                autocomplete="off"
                        >
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label">
                        <i class="bi bi-ui-checks me-1"></i>Status
                    </label>
                    <select name="status" class="form-select">
                        <option value="all" {{ status == 'all' ? 'selected' : '' }}>All</option>
                        <option value="approved" {{ status == 'approved' ? 'selected' : '' }}>Approved</option>
                        <option value="pending" {{ status == 'pending' ? 'selected' : '' }}>Pending</option>
                        <option value="rejected" {{ status == 'rejected' ? 'selected' : '' }}>Rejected</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">
                        <i class="bi bi-lock me-1"></i>Type
                    </label>
                    <select name="type" class="form-select">
                        <option value="all" {{ type == 'all' ? 'selected' : '' }}>All</option>
                        <option value="public" {{ type == 'public' ? 'selected' : '' }}>Public</option>
                        <option value="private" {{ type == 'private' ? 'selected' : '' }}>Private</option>
                    </select>
                </div>

                <div class="col-md-2 d-flex align-items-end gap-2">
                    <button class="btn btn-primary flex-grow-1" type="submit">
                        <i class="bi bi-search me-1"></i>Filter
                    </button>

                    {% if q or status != 'all' or type != 'all' or active != 'all' %}
                        <a
                                href="{{ path('admin_channels_index') }}"
                                class="btn btn-outline-secondary"
                                title="Clear"
                        >
                            <i class="bi bi-x-lg"></i>
                        </a>
                    {% endif %}
                </div>

            </div>
        </form>
    </div>

    {# ✅ Inject CSRF map for delete modal #}
    <script>
        window.__deleteTokens = {
            {% for c in channels %}
            "{{ c.id }}": "{{ csrf_token('admin_delete_channel_' ~ c.id) }}",
            {% endfor %}
        };
    </script>


    {# ✅ Results zone (dynamic) #}
    <div id="channelsResults">
        {{ include('admin/channel/_table.html.twig', {
            channels: channels,
            pendingCount: pendingCount,
            q: q,
            status: status,
            type: type,
            active: active,
            sort: sort,
            dir: dir
        }) }}
    </div>


{% endblock %}

{% block javascripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            document.querySelectorAll('[title]').forEach(el => {
                new bootstrap.Tooltip(el, {
                    delay: { show: 300, hide: 100 }
                });
            });

            const deleteModalEl = document.getElementById('deleteChannelModal');

            if (deleteModalEl) {
                deleteModalEl.addEventListener('show.bs.modal', (event) => {
                    const btn = event.relatedTarget;
                    const id = btn.getAttribute('data-channel-id');
                    const name = btn.getAttribute('data-channel-name');
                    const count = parseInt(btn.getAttribute('data-messages-count') || '0', 10);

                    document.getElementById('modalChannelName').textContent = name;
                    document.getElementById('modalMessagesCount').textContent = count;
                    document.getElementById('modalWarningEmpty').style.display = (count === 0) ? 'block' : 'none';
                    document.getElementById('modalWarningNotEmpty').style.display = (count > 0) ? 'block' : 'none';

                    const form = document.getElementById('deleteChannelForm');
                    form.action = btn.getAttribute('data-delete-url');

                    const tokens = window.__deleteTokens || {};
                    document.getElementById('deleteChannelToken').value = tokens[id] || '';
                });
            }
        });

        function openRejectModal(id, name, token) {
            document.getElementById('rejectChannelName').textContent = name;
            document.getElementById('rejectToken').value = token;

            const form = document.getElementById('rejectChannelForm');
            form.action = "{{ path('admin_channels_reject', {id: 'ID'}) }}".replace('ID', id);

            const input = document.getElementById('rejectReasonInput');
            const hidden = document.getElementById('rejectReasonHidden');

            input.value = '';
            hidden.value = '';
            input.oninput = () => hidden.value = input.value;

            bootstrap.Modal
                .getOrCreateInstance(document.getElementById('rejectChannelModal'))
                .show();
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.querySelector('form[action="{{ path('admin_channels_index') }}"]');
            const results = document.getElementById('channelsResults');

            if (!form || !results) return;

            let t = null;

            function runFetch() {
                const params = new URLSearchParams(new FormData(form));
                const url = form.action + '?' + params.toString();

                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                    .then(r => r.text())
                    .then(html => {
                        results.innerHTML = html;
                        history.replaceState(null, '', url);
                    })
                    .catch(console.error);
            }

            // debounce for typing
            form.addEventListener('input', (e) => {
                clearTimeout(t);
                t = setTimeout(runFetch, 250);
            });

            // immediate for selects
            form.addEventListener('change', () => {
                clearTimeout(t);
                runFetch();
            });
        });
    </script>
{% endblock %}

{% block modals %}
    {{ include('admin/channel/_delete_modal.html.twig') }}
    {{ include('admin/channel/_reject_modal.html.twig') }}
{% endblock %}