{% extends 'admin_layout.html.twig' %}

{% block title %}
    Channels Management
{% endblock %}

{% block page_title %}
    Channels Management
{% endblock %}

{% block body %}
    <style>
        .sort-icons{
            display:inline-flex;
            flex-direction:column;
            line-height:0.65;
            font-size:0.7rem;
            margin-left:.25rem;
            vertical-align:middle;
        }
        .sort-icons span { opacity:.35; }
        .sort-icons span.active { opacity:1; }
    </style>
    {% macro sort_link(label, field, q, status, sort, dir) %}
        {% set nextDir = (sort == field and dir == 'asc') ? 'desc' : 'asc' %}
        <a class="text-decoration-none" style="color: inherit;"
           href="{{ path('admin_channels_index', { q: q, status: status, sort: field, dir: nextDir }) }}">
            {{ label }}
            {% if sort == field %}
                <i class="bi {{ dir == 'asc' ? 'bi-caret-up-fill' : 'bi-caret-down-fill' }} ms-1"></i>
            {% else %}
                <i class="bi bi-arrow-down-up ms-1" style="opacity: .4;"></i>
            {% endif %}
        </a>
    {% endmacro %}
    {% import _self as ui %}

    {# ✅ Filters & Search #}
    <div class="table-card mb-4 fade-in">
        <div class="table-header">
            <h5>
                <i class="bi bi-funnel me-2"></i>
                Filters & Search
            </h5>
        </div>

        <form id="channelsFiltersForm" method="get" action="{{ path('admin_channels_index') }}" class="p-3">
            <div class="row g-3">

                <div class="col-md-4">
                    <label class="form-label">
                        <i class="bi bi-search me-1"></i>Search
                    </label>
                    <div class="search-bar">
                        <i class="search-icon bi bi-search"></i>
                        <input
                                type="text"
                                name="q"
                                class="form-control"
                                placeholder="Name, game, createdBy..."
                                value="{{ q }}"
                                autocomplete="off"
                        >
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label">
                        <i class="bi bi-ui-checks me-1"></i>Status
                    </label>
                    <select name="status" class="form-select">
                        <option value="all" {{ status == 'all' ? 'selected' : '' }}>All</option>
                        <option value="approved" {{ status == 'approved' ? 'selected' : '' }}>Approved</option>
                        <option value="pending" {{ status == 'pending' ? 'selected' : '' }}>Pending</option>
                        <option value="rejected" {{ status == 'rejected' ? 'selected' : '' }}>Rejected</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">
                        <i class="bi bi-lock me-1"></i>Type
                    </label>
                    <select name="type" class="form-select">
                        <option value="all" {{ type == 'all' ? 'selected' : '' }}>All</option>
                        <option value="public" {{ type == 'public' ? 'selected' : '' }}>Public</option>
                        <option value="private" {{ type == 'private' ? 'selected' : '' }}>Private</option>
                    </select>
                </div>

                <div class="col-md-2 d-flex align-items-end gap-2">
                    <button class="btn btn-primary flex-grow-1" type="submit">
                        <i class="bi bi-search me-1"></i>Filter
                    </button>

                    {% if q or status != 'all' or type != 'all' or active != 'all' %}
                        <a
                                href="{{ path('admin_channels_index') }}"
                                class="btn btn-outline-secondary"
                                title="Clear"
                        >
                            <i class="bi bi-x-lg"></i>
                        </a>
                    {% endif %}
                </div>

            </div>
        </form>
    </div>

    {# ✅ Summary + Add Channel #}
{#    <div class="mb-3 fade-in" style="animation-delay: 0.1s;">#}
{#        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">#}
{#            <h6 class="text-muted mb-0">#}
{#                <i class="bi bi-info-circle me-2"></i>#}
{#                Found <strong>{{ channels|length }}</strong>#}
{#                channel{{ channels|length != 1 ? 's' : '' }}#}

{#                {% if pendingCount > 0 %}#}
{#                    <span class="badge bg-warning ms-2">#}
{#                        <i class="bi bi-hourglass-split me-1"></i>#}
{#                        {{ pendingCount }} pending#}
{#                    </span>#}
{#                {% endif %}#}
{#            </h6>#}

{#            <a href="{{ path('admin_channels_new') }}" class="btn btn-success">#}
{#                <i class="bi bi-plus-circle me-2"></i>New Channel#}
{#            </a>#}
{#        </div>#}
{#    </div>#}

    {# ✅ Inject CSRF map for delete modal #}
    <script>
        window.__deleteTokens = {
            {% for c in channels %}
            "{{ c.id }}": "{{ csrf_token('admin_delete_channel_' ~ c.id) }}",
            {% endfor %}
        };
    </script>

    {# ✅ Channels Table #}
{#    <div class="table-card fade-in" style="animation-delay: 0.2s;">#}
{#        <div class="table-header">#}
{#            <h5>#}
{#                <i class="bi bi-chat-square-dots me-2"></i>#}
{#                Channels List#}
{#            </h5>#}
{#        </div>#}

{#        <div class="table-responsive">#}
{#            {% set query = app.request.query.all %}#}
{#            {% set currentSort = sort|default('createdAt') %}#}
{#            {% set currentDir  = dir|default('desc') %}#}
{#            <table class="custom-table table">#}
{#                <thead>#}
{#                <tr>#}
{#                    <th style="width:80px;">#</th>#}
{#                    <th style="width:220px;">{{ ui.sort_link('Name', 'name', q, status, sort, dir) }}</th>#}
{#                    <th style="width:140px;">{{ ui.sort_link('Game', 'game', q, status, sort, dir) }}</th>#}
{#                    <th style="width:120px;">{{ ui.sort_link('Type', 'type', q, status, sort, dir) }}</th>#}
{#                    <th style="width:140px;">Status</th>#}
{#                    <th style="width:110px;">Active</th>#}
{#                    <th style="width:200px;">Created By</th>#}
{#                    <th style="width:200px;">Actions</th>#}
{#                </tr>#}
{#                </thead>#}

{#                <tbody>#}
{#                {% for c in channels %}#}
{#                    <tr class="fade-in" style="animation-delay: {{ loop.index * 0.03 }}s;">#}
{#                        <td><strong>{{ c.id }}</strong></td>#}

{#                        <td>#}
{#                            <strong>{{ c.name }}</strong>#}
{#                            {% if c.rejectionReason %}#}
{#                                <div class="text-muted" style="font-size: 12px; opacity: .8;">#}
{#                                    <i class="bi bi-info-circle me-1"></i>#}
{#                                    {{ c.rejectionReason }}#}
{#                                </div>#}
{#                            {% endif %}#}
{#                        </td>#}

{#                        <td>{{ c.game }}</td>#}

{#                        <td>#}
{#                            {% if c.type == 'public' %}#}
{#                                <span class="badge bg-info">#}
{#                                        <i class="bi bi-globe me-1"></i>Public#}
{#                                    </span>#}
{#                            {% else %}#}
{#                                <span class="badge bg-secondary">#}
{#                                        <i class="bi bi-lock-fill me-1"></i>Private#}
{#                                    </span>#}
{#                            {% endif %}#}
{#                        </td>#}

{#                        <td>#}
{#                            {% if c.status == 'approved' %}#}
{#                                <span class="badge bg-success">#}
{#                                        <i class="bi bi-check-circle me-1"></i>Approved#}
{#                                    </span>#}
{#                            {% elseif c.status == 'pending' %}#}
{#                                <span class="badge bg-warning text-dark">#}
{#                                        <i class="bi bi-hourglass-split me-1"></i>Pending#}
{#                                    </span>#}
{#                            {% else %}#}
{#                                <span class="badge bg-danger">#}
{#                                        <i class="bi bi-x-circle me-1"></i>Rejected#}
{#                                    </span>#}
{#                            {% endif %}#}
{#                        </td>#}

{#                        <td>#}
{#                            {% if c.isActive %}#}
{#                                <span class="badge bg-success">Yes</span>#}
{#                            {% else %}#}
{#                                <span class="badge bg-secondary">No</span>#}
{#                            {% endif %}#}
{#                        </td>#}

{#                        <td>#}
{#                            <small class="text-muted">{{ c.createdBy ?? '-' }}</small>#}
{#                        </td>#}

{#                        <td>#}
{#                            <div class="btn-group" role="group">#}
{#                                <a#}
{#                                        class="btn btn-sm btn-warning"#}
{#                                        href="{{ path('admin_channels_edit', {id: c.id}) }}"#}
{#                                        data-bs-toggle="tooltip"#}
{#                                        title="Edit"#}
{#                                >#}
{#                                    <i class="bi bi-pencil"></i>#}
{#                                </a>#}

{#                                {% if c.status == 'pending' %}#}
{#                                    <button#}
{#                                            type="button"#}
{#                                            class="btn btn-sm btn-success"#}
{#                                            onclick="confirmAction('{{ path('admin_channels_approve', {id: c.id}) }}', '{{ csrf_token('approve_' ~ c.id) }}', 'Approve this channel?')"#}
{#                                            data-bs-toggle="tooltip"#}
{#                                            title="Approve"#}
{#                                    >#}
{#                                        <i class="bi bi-check-lg"></i>#}
{#                                    </button>#}

{#                                    <button#}
{#                                            type="button"#}
{#                                            class="btn btn-sm btn-danger"#}
{#                                            onclick="openRejectModal({{ c.id }}, '{{ c.name|e('js') }}', '{{ csrf_token('reject_' ~ c.id) }}')"#}
{#                                            title="Reject"#}
{#                                    >#}
{#                                        <i class="bi bi-x-lg"></i>#}
{#                                    </button>#}
{#                                {% endif %}#}

{#                                <button#}
{#                                        type="button"#}
{#                                        class="btn btn-sm btn-secondary"#}
{#                                        onclick="confirmAction('{{ path('admin_channels_toggle', {id: c.id}) }}', '{{ csrf_token('toggle_' ~ c.id) }}', 'Toggle active state?')"#}
{#                                        data-bs-toggle="tooltip"#}
{#                                        title="Toggle active"#}
{#                                >#}
{#                                    <i class="bi bi-toggle2-on"></i>#}
{#                                </button>#}

{#                                <button#}
{#                                        type="button"#}
{#                                        class="btn btn-sm btn-danger"#}
{#                                        data-bs-toggle="modal"#}
{#                                        data-bs-target="#deleteChannelModal"#}
{#                                        data-channel-id="{{ c.id }}"#}
{#                                        data-channel-name="{{ c.name|e('html_attr') }}"#}
{#                                        data-messages-count="{{ c.messages|length }}"#}
{#                                        data-delete-url="{{ path('admin_channels_delete', {id: c.id}) }}"#}
{#                                        title="Delete"#}
{#                                >#}
{#                                    <i class="bi bi-trash"></i>#}
{#                                </button>#}
{#                            </div>#}
{#                        </td>#}
{#                    </tr>#}
{#                {% else %}#}
{#                    <tr>#}
{#                        <td colspan="8" class="text-center text-muted py-5">#}
{#                            <div class="empty-state">#}
{#                                <i class="bi bi-inbox" style="font-size: 64px; opacity: 0.2;"></i>#}
{#                                <h4 class="mt-3 mb-2">No Channels Found</h4>#}
{#                                <p class="text-muted">Try adjusting filters</p>#}
{#                            </div>#}
{#                        </td>#}
{#                    </tr>#}
{#                {% endfor %}#}
{#                </tbody>#}
{#            </table>#}
{#        </div>#}
{#    </div>#}

    {# ✅ Results zone (dynamic) #}
    <div id="channelsResults">
        {{ include('admin/channel/_table.html.twig', {
            channels: channels,
            pendingCount: pendingCount,
            q: q,
            status: status,
            type: type,
            active: active,
            sort: sort,
            dir: dir
        }) }}
    </div>


{% endblock %}

{% block javascripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            document.querySelectorAll('[title]').forEach(el => {
                new bootstrap.Tooltip(el, {
                    delay: { show: 300, hide: 100 }
                });
            });

            const deleteModalEl = document.getElementById('deleteChannelModal');

            if (deleteModalEl) {
                deleteModalEl.addEventListener('show.bs.modal', (event) => {
                    const btn = event.relatedTarget;
                    const id = btn.getAttribute('data-channel-id');
                    const name = btn.getAttribute('data-channel-name');
                    const count = parseInt(btn.getAttribute('data-messages-count') || '0', 10);

                    document.getElementById('modalChannelName').textContent = name;
                    document.getElementById('modalMessagesCount').textContent = count;
                    document.getElementById('modalWarningEmpty').style.display = (count === 0) ? 'block' : 'none';
                    document.getElementById('modalWarningNotEmpty').style.display = (count > 0) ? 'block' : 'none';

                    const form = document.getElementById('deleteChannelForm');
                    form.action = btn.getAttribute('data-delete-url');

                    const tokens = window.__deleteTokens || {};
                    document.getElementById('deleteChannelToken').value = tokens[id] || '';
                });
            }
        });

        function openRejectModal(id, name, token) {
            document.getElementById('rejectChannelName').textContent = name;
            document.getElementById('rejectToken').value = token;

            const form = document.getElementById('rejectChannelForm');
            form.action = "{{ path('admin_channels_reject', {id: 'ID'}) }}".replace('ID', id);

            const input = document.getElementById('rejectReasonInput');
            const hidden = document.getElementById('rejectReasonHidden');

            input.value = '';
            hidden.value = '';
            input.oninput = () => hidden.value = input.value;

            bootstrap.Modal
                .getOrCreateInstance(document.getElementById('rejectChannelModal'))
                .show();
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.querySelector('form[action="{{ path('admin_channels_index') }}"]');
            const results = document.getElementById('channelsResults');

            if (!form || !results) return;

            let t = null;

            function runFetch() {
                const params = new URLSearchParams(new FormData(form));
                const url = form.action + '?' + params.toString();

                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                    .then(r => r.text())
                    .then(html => {
                        results.innerHTML = html;
                        history.replaceState(null, '', url);
                    })
                    .catch(console.error);
            }

            // debounce for typing
            form.addEventListener('input', (e) => {
                clearTimeout(t);
                t = setTimeout(runFetch, 250);
            });

            // immediate for selects
            form.addEventListener('change', () => {
                clearTimeout(t);
                runFetch();
            });
        });
    </script>
{% endblock %}

{% block modals %}
    {{ include('admin/channel/_delete_modal.html.twig') }}
    {{ include('admin/channel/_reject_modal.html.twig') }}
{% endblock %}