<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Verification - EyeTwin Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#1a0e2e 0%,#2d1b3d 50%,#1a0e2e 100%);color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
        .container{background:rgba(20,10,35,.95);backdrop-filter:blur(20px);border-radius:20px;border:1px solid rgba(255,255,255,.1);box-shadow:0 20px 60px rgba(0,0,0,.5);max-width:680px;width:100%;padding:40px;animation:slideUp .6s ease}
        @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
        .header{text-align:center;margin-bottom:28px}
        .header img{max-width:150px;margin-bottom:18px}
        .header h1{font-size:26px;font-weight:700;margin-bottom:8px}
        .header p{font-size:13px;color:rgba(255,255,255,.6)}
        .status{padding:14px 16px;border-radius:12px;font-size:13px;display:flex;align-items:center;gap:12px;border:1px solid;margin:18px 0;transition:all .3s}
        .status.info{background:rgba(90,103,216,.15);border-color:rgba(90,103,216,.3);color:#818cf8}
        .status.success{background:rgba(67,233,123,.15);border-color:rgba(67,233,123,.3);color:#43e97b}
        .status.error{background:rgba(255,60,100,.15);border-color:rgba(255,60,100,.3);color:#ff3c64}
        .status.warning{background:rgba(255,193,7,.15);border-color:rgba(255,193,7,.3);color:#ffc107}
        .status i{font-size:18px;flex-shrink:0}
        .video-wrapper{position:relative;border-radius:14px;overflow:hidden;background:#000;margin:18px 0}
        #video{width:100%;display:block}
        #overlay{position:absolute;top:0;left:0;width:100%;height:100%}
        .btn-verify{width:100%;padding:15px;background:linear-gradient(135deg,#ff3c64,#ff1744);color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;text-transform:uppercase;letter-spacing:.8px;box-shadow:0 6px 20px rgba(255,60,100,.3);transition:all .3s}
        .btn-verify:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 10px 28px rgba(255,60,100,.4)}
        .btn-verify:disabled{opacity:.5;cursor:not-allowed}
        .btn-cancel{width:100%;padding:13px;background:transparent;color:rgba(255,255,255,.6);border:1px solid rgba(255,255,255,.15);border-radius:12px;font-size:13px;font-weight:600;cursor:pointer;margin-top:10px;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn-cancel:hover{background:rgba(255,255,255,.05);color:#fff}
        .hint{text-align:center;font-size:12px;color:rgba(255,255,255,.35);margin-top:16px}
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <img src="{{ asset('assets/img/eyetwin-logo.png') }}" alt="EyeTwin">
        <h1>ðŸŽ­ Face Verification</h1>
        <p>Look at the camera to log in automatically</p>
    </div>

    <div class="status info" id="status">
        <i class="bi bi-hourglass-split"></i>
        <span>Loading AI modelsâ€¦</span>
    </div>

    <div class="video-wrapper" id="videoWrapper" style="display:none;">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
    </div>

    <button id="verifyBtn" class="btn-verify" disabled>
        <i class="bi bi-camera-fill"></i>
        <span>Verify my face</span>
    </button>

    <button id="cancelBtn" class="btn-cancel">
        <i class="bi bi-arrow-left"></i>
        Back to login
    </button>

    <p class="hint">Make sure you are in a well-lit area and look straight at the camera.</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script>
    const video        = document.getElementById('video');
    const canvas       = document.getElementById('overlay');
    const statusDiv    = document.getElementById('status');
    const verifyBtn    = document.getElementById('verifyBtn');
    const cancelBtn    = document.getElementById('cancelBtn');
    const videoWrapper = document.getElementById('videoWrapper');

    const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';
    let detectionInterval = null;

    function setStatus(type, icon, msg) {
        statusDiv.className = `status ${type}`;
        statusDiv.innerHTML = `<i class="bi ${icon}"></i><span>${msg}</span>`;
    }

    function stopCamera() {
        if (detectionInterval) clearInterval(detectionInterval);
        if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
    }

    cancelBtn.addEventListener('click', () => {
        stopCamera();
        window.location.href = '{{ path("admin_login") }}';
    });

    // â”€â”€ Chargement des modÃ¨les â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadModels() {
        try {
            setStatus('info', 'bi-hourglass-split', 'Loading AI modelsâ€¦');
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
            await startVideo();
        } catch (e) {
            setStatus('error', 'bi-x-circle', 'Model error: ' + e.message);
        }
    }

    // â”€â”€ DÃ©marrage camÃ©ra â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function startVideo() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'user' }
            });
            video.srcObject = stream;
            video.addEventListener('loadedmetadata', () => {
                videoWrapper.style.display = 'block';
                canvas.width  = video.videoWidth;
                canvas.height = video.videoHeight;
                setStatus('success', 'bi-camera', 'Camera active â€” position your face and click Verify.');
                verifyBtn.disabled = false;
                startDetection();
            });
        } catch (e) {
            setStatus('error', 'bi-exclamation-triangle', 'Cannot access camera: ' + e.message);
        }
    }

    // â”€â”€ DÃ©tection temps rÃ©el â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startDetection() {
        const ctx = canvas.getContext('2d');
        detectionInterval = setInterval(async () => {
            try {
                const dets = await faceapi
                    .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (dets.length > 0) {
                    const resized = faceapi.resizeResults(dets, { width: canvas.width, height: canvas.height });
                    faceapi.draw.drawDetections(canvas, resized);
                    faceapi.draw.drawFaceLandmarks(canvas, resized);
                    if (dets.length === 1) {
                        setStatus('success', 'bi-person-check', 'Face detected âœ“ â€” click Verify to log in.');
                    } else {
                        setStatus('warning', 'bi-people', `${dets.length} faces detected â€” only one allowed.`);
                    }
                } else {
                    setStatus('info', 'bi-search', 'Searching for your faceâ€¦');
                }
            } catch (_) {}
        }, 100);
    }

    // â”€â”€ VÃ©rification et connexion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    verifyBtn.addEventListener('click', async () => {
        verifyBtn.disabled = true;
        clearInterval(detectionInterval);
        setStatus('info', 'bi-hourglass-split', 'Analysing your faceâ€¦');

        try {
            await new Promise(r => setTimeout(r, 300)); // petit dÃ©lai pour stabiliser

            const detection = await faceapi
                .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceDescriptor();

            if (!detection) {
                throw new Error('No face detected. Make sure your face is clearly visible.');
            }

            setStatus('info', 'bi-cloud-upload', 'Identifyingâ€¦');

            const response = await fetch('{{ path("admin_face_verify_submit") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    descriptor: Array.from(detection.descriptor)
                })
            });

            const result = await response.json();

            if (result.success) {
                setStatus('success', 'bi-shield-check', 'âœ“ Identity confirmed! Redirectingâ€¦');
                stopCamera();
                setTimeout(() => { window.location.href = result.redirect; }, 1000);
            } else {
                setStatus('error', 'bi-x-circle', result.message || 'Face not recognised.');
                verifyBtn.disabled = false;
                startDetection();
            }
        } catch (e) {
            setStatus('error', 'bi-exclamation-triangle', e.message);
            verifyBtn.disabled = false;
            startDetection();
        }
    });

    window.addEventListener('beforeunload', stopCamera);
    loadModels();
</script>
</body>
</html>
